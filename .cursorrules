# .cursorrules

## 使命（Purpose）
確保在 Cursor 專案中，所有 AI／人類協作都能：
1. **持續學習**：即時記錄錯誤與修正，避免重蹈覆轍  
2. **系統化思考**：在 Scratchpad 中拆解、追蹤、反思每項任務  
3. **自我進化**：隨著專案進展，自動汰換過時資訊、擴充新經驗  

---

## 區塊結構（File Sections）

### 1. Lessons  
- **User-Specified Lessons**：使用者明確指出的注意事項或偏好  
- **Cursor-Learned**：AI 在對話中獲得的修正、最佳解法或踩坑經驗  
- **更新規則**  
  1. 一旦遇到可重複利用的經驗，立即寫入此區塊  
  2. 以條列簡短描述「錯誤 → 修正 → 結論」  

### 2. Scratchpad  
為「進行中任務」的暫存區，協助**思考、拆解、追蹤**。  
建議結構：  

```md
## Plan
- [ ] 步驟 1  
- [ ] 步驟 2  
  - 子步驟  
- [ ] 步驟 3  

## Progress
- 2025-05-20 02:15  ✅ 完成步驟 1，意外發現 X 問題  
- 2025-05-20 03:10  ➡️ 修正並更新 Lessons  
````

> **規範**
>
> * 僅放「尚未完成」或「需要回顧」的事項
> * 任務完成後，將相關筆記移至 Lessons 或刪除
> * 定期（建議每日／每次任務結束）清理過期內容，保持精簡

---

## 自我進化機制（Self-Evolution）

1. **事件驅動更新**

   * 當發生「錯誤被糾正」「新工具版本」「重構大改」等事件，立即寫入 *Lessons*
2. **週期性回顧**

   * 於每週或里程碑結束時，檢查 Scratchpad 與 Lessons：

     * 刪除無用資訊
     * 合併重複經驗
     * 標註已過時的做法
3. **版本註記**

   * 重要調整可附上日期與簡短說明，方便追溯
4. **遷移策略**

   * 若經驗屬於跨專案共通知識，考慮抽離到中央知識庫或維基

---

## 使用守則（Best Practices）

1. **先讀後寫**：接到新任務→先掃過 Scratchpad，確保不重複、方向正確
2. **小步快寫**：任何靈感、疑問、暫時結論都先丟進 Scratchpad，再逐步整理
3. **完成即歸檔**：任務結束立即把重點學習寫到 Lessons，並刪除或精簡 Scratchpad
4. **保持原子性**：每條 Lesson 僅描述一個教訓，方便搜尋與重用
5. **用日期戳記**：Progress 與 Lessons 建議加時間，提升可追溯性
6. **避免冗長**：Scratchpad ≠ 最終文件；寫足夠讓自己回想即可

---

# Lessons

## User-Specified Lessons
- 用繁體中文回話，但 code 內的註釋請全使用英文
- Git commit 請以英文生成，並盡可能的簡短、簡約描述，請以不超過 70 個字元為標準

## Cursor-Learned
- **2025-01-12**  
  - *實作*：完成 Magic Link 認證系統的完整後端實作  
  - *架構*：使用 Redis 儲存短期驗證 token（15分鐘 TTL），JWT 用於長期 access token  
  - *結論*：短期驗證 token 應使用 Redis 而非 MongoDB，利用自動過期和高速查詢特性

- **2025-01-12**  
  - *前端*：實作響應式設計時遇到通知溢出問題  
  - *修正*：移除 `white-space: nowrap` 衝突，改用 `word-wrap: break-word` 處理長文字  
  - *結論*：通知系統需要在美觀和功能性間平衡，允許適當換行比強制單行更實用

- **2025-01-12**  
  - *安全*：整合 Cloudflare Turnstile 隱形驗證防止濫用  
  - *實作*：Magic Link 先檢查 MongoDB 用戶存在性，避免向不存在用戶發送郵件  
  - *架構*：Turnstile 驗證完成後才送出請求，每次送出後自動重新刷新 widget  
  - *結論*：隱形驗證提供良好用戶體驗，同時有效防止機器人攻擊和流量濫用

- **2025-01-12**  
  - *錯誤*：MongoDB 連接字符串密碼包含特殊字符導致認證失敗  
  - *修正*：將密碼中的 `*` 編碼為 `%2A`，`!` 編碼為 `%21`  
  - *結論*：MongoDB URI 中的密碼必須進行完整的 URL 編碼，特別是特殊字符

- **2025-06-12**  
  - *錯誤*：MongoDB 連線方式錯誤導致認證失敗，URI 格式不正確  
  - *修正*：改用 `connect(db=settings.MONGODB_DATABASE, host=settings.MONGODB_URI)` 避免字串串接錯誤  
  - *結論*：MongoDB 連線應使用 mongoengine 標準參數而非字串串接

- **2025-06-12**  
  - *錯誤*：Gmail SMTP 設定衝突，465 連接埠 + STARTTLS 導致連線失敗  
  - *修正*：465 連接埠應使用 `MAIL_SSL_TLS=True` 和 `MAIL_STARTTLS=False`  
  - *結論*：SMTPS (465) 需要直接 SSL/TLS，STARTTLS 用於明文升級加密 (587)

- **2025-06-12**  
  - *功能*：實作 Magic Link 防濫用機制  
  - *邏輯*：15分鐘內重複請求重發相同 token，超過3次拒絕服務  
  - *架構*：使用 Redis 存儲 email-token 映射和發送次數，兩者都有15分鐘TTL  
  - *結論*：防濫用需要平衡用戶體驗和系統安全，重用token比拒絕服務更友善

- **2025-06-12**  
  - *功能*：允許 Magic Link 在15分鐘內重複使用，改善用戶體驗  
  - *修正*：移除 token 驗證後自動刪除的邏輯，允許多次點擊同一連結  
  - *安全*：整合真實IP顯示功能，支援 Cloudflare 代理環境  
  - *UX*：將郵件語調改為親切非正式風格，移除過度正式的用詞

- **2025-06-12**  
  - *UI/UX*：實作完整的已登入狀態介面  
  - *功能*：SSO頁面檢測登入狀態，顯示用戶頭像、姓名和登出按鈕  
  - *架構*：新增 `/auth/status` 和 `/auth/logout` API，JWT包含完整用戶資訊  
  - *前端*：localStorage 管理 token，支援 Base64 頭像顯示和響應式設計

- **2025-06-12**  
  - *架構*：實作軍用級別SSO跨域認證系統  
  - *安全*：HMAC-SHA256簽名驗證、域名白名單、防重放攻擊機制  
  - *API*：提供 `/auth/sso/verify`、`/auth/sso/config`、`/auth/sso/refresh` 端點  
  - *SDK*：完整JavaScript SDK支援React、Vue.js框架，自動token刷新

- **2025-01-12**  
  - *修正*：移除Magic Link自動創建帳號功能，恢復只允許現有用戶登入的邏輯  
  - *安全*：用戶不存在時顯示「查無此帳號，請確認您的電子郵件地址是否正確。」  
  - *架構*：create_user_session改用get_user_by_email，完全禁止自動創建用戶  
  - *結論*：系統安全性優於便利性，新用戶需要透過其他管道註冊

# Scratchpad

## Plan
- [x] 建立專案基礎架構（FastAPI + MongoDB + Redis）
- [x] 設計前端登入介面（Apple 風格 + 毛玻璃效果）
- [x] 實作 Magic Link 完整流程
  - [x] JWT token 生成與驗證
  - [x] Redis 短期 token 儲存
  - [x] 郵件服務整合
  - [x] 用戶 CRUD 操作
  - [x] 認證路由與驗證頁面
- [x] 整合安全防護機制
  - [x] Cloudflare Turnstile 隱形驗證
  - [x] 用戶存在性檢查
  - [x] 防止流量濫用
- [x] 修復 MongoDB 連線問題
- [x] 修復 Gmail SMTP 設定問題
- [x] 實作 Magic Link 防濫用機制
- [x] 實作已登入狀態UI與登出功能
- [x] 實作企業級SSO跨域認證系統
- [ ] 測試完整流程
- [ ] 部署準備

## Progress
- 2025-06-12 修復 MongoDB 認證失敗問題，改用標準 mongoengine 連線方式
- 2025-06-12 修復 Gmail SMTP 設定衝突，調整 SSL/TLS 和 STARTTLS 設定
- 2025-06-12 實作 Magic Link 防濫用機制：15分鐘內重複請求重發相同 token，超過3次拒絕服務，使用 Redis 追蹤狀態
- 2025-06-12 改進 Magic Link 使用體驗：允許15分鐘內重複使用、顯示登入IP、改用親切語調
- 2025-06-12 實作已登入狀態UI：檢測登入狀態、顯示用戶資訊、登出功能，完整的前後端整合
- 2025-06-12 完成企業級SSO跨域認證系統：軍用級安全機制、完整API文檔、JavaScript SDK
- 2025-06-12 統一等待狀態文字：將所有倒數、準備中、驗證中等文字統一改為"處理中"

---

## 範例（Example）

```md
# Lessons

## Cursor-Learned
- **2025-05-20**  
  - *錯誤*：未遵守 matplotlib 只能單圖、不指定顏色的規定  
  - *修正*：改為分次繪圖並移除 color 參數  
  - *結論*：未來繪圖須檢查三條規則（不使用 seaborn、單張圖、不指定顏色）

# Scratchpad

## Plan
- [ ] 搜集使用者需求
- [ ] 設計資料流程
- [ ] 撰寫 API 介面

## Progress
- 05-20 02:20  完成需求訪談摘要
```

---

> ***保持簡潔、即時更新，讓 .cursorrules 成為專案的「作業系統」。***